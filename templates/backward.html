{% extends 'layout.html' %}

{% block title %}Diagnosis - Sistem Pakar Kerusakan Komputer{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Header -->
      <div class="text-center mb-5">
        <h1 class="fw-bold">Diagnosis Kerusakan Komputer</h1>
        <p class="text-muted">Pilih hipotesis kerusakan dan konfirmasi gejala yang terjadi</p>
      </div>

      <!-- Hypothesis Selection -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="bi bi-lightbulb me-2"></i>Langkah 1: Pilih Hipotesis Kerusakan
          </h4>
        </div>
        <div class="card-body">
          <!-- Search Box -->
          <div class="search-box mb-4">
            <i class="bi bi-search"></i>
            <input type="text" class="form-control" id="hypothesisSearch" placeholder="Cari jenis kerusakan...">
          </div>

          <!-- Hypothesis Cards -->
          <div class="row g-3">
            {% for kode, nama in kerusakan.items() %}
            <div class="col-md-6">
              <div class="hypothesis-card" data-hypothesis="{{ kode }}">
                <div class="hypothesis-code">{{ kode }}</div>
                <h5 class="mb-1">{{ nama }}</h5>
                <small class="text-muted">Klik untuk memilih hipotesis ini</small>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Mode Selection -->
      <div id="modeSelection" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">
            <i class="bi bi-gear me-2"></i>Langkah 2: Pilih Mode Diagnosis
          </h4>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card border-primary h-100">
                <div class="card-body text-center">
                  <i class="bi bi-lightning-fill text-primary fs-1 mb-3"></i>
                  <h5>Mode Cepat</h5>
                  <p class="text-muted">Lihat semua gejala sekaligus dan pilih yang sesuai</p>
                  <button class="btn btn-primary" id="quickModeBtn">
                    <i class="bi bi-check2 me-2"></i>Pilih Mode Ini
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-success h-100">
                <div class="card-body text-center">
                  <i class="bi bi-compass-fill text-success fs-1 mb-3"></i>
                  <h5>Mode Terpandu</h5>
                  <p class="text-muted">Jawab pertanyaan satu per satu untuk hasil lebih akurat</p>
                  <button class="btn btn-success" id="guidedModeBtn">
                    <i class="bi bi-check2 me-2"></i>Pilih Mode Ini
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Mode Screen -->
      <div id="quickModeScreen" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="bi bi-check2-square me-2"></i>Langkah 3: Konfirmasi Gejala
          </h4>
        </div>
        <div class="card-body">
          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Progress Konfirmasi</span>
              <span class="text-muted" id="quickModeProgressText">0%</span>
            </div>
            <div class="progress">
              <div class="progress-bar" id="quickModeProgress" style="width: 0%"></div>
            </div>
          </div>

          <!-- Symptom Checkboxes -->
          <div id="symptomCheckboxes" class="row g-3">
            <!-- Will be populated by JavaScript -->
          </div>

          <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary btn-lg" onclick="backwardChaining.showResults()">
              <i class="bi bi-search me-2"></i>Lihat Hasil Diagnosis
            </button>
            <button class="btn btn-outline-secondary" onclick="location.reload()">
              <i class="bi bi-arrow-clockwise me-2"></i>Pilih Hipotesis Lain
            </button>
          </div>
        </div>
      </div>

      <!-- Guided Mode Screen -->
      <div id="guidedModeScreen" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">
            <i class="bi bi-question-circle me-2"></i>Mode Diagnosis Terpandu
          </h4>
        </div>
        <div class="card-body">
          <div id="questionContainer">
            <!-- Questions will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Results Container -->
      <div id="resultsContainer">
        <!-- Results will be populated by JavaScript -->
      </div>

      <!-- Previous Results (if any) -->
      {% if hasil %}
      <div class="result-card {{ hasil.css }}">
        <div class="card-body">
          <div class="text-center mb-4">
            <h3 class="fw-bold">{{ hasil.nama }}</h3>
            <p class="text-muted">Hasil Analisa Hipotesis</p>

            <div class="confidence-score text-{{ hasil.css }}">{{ hasil.persen }}%</div>
            <div class="confidence-meter mb-3">
              <div class="confidence-fill bg-{{ hasil.css }}"></div>
            </div>
            <div class="confidence-labels">
              <span>0%</span>
              <span>25%</span>
              <span>50%</span>
              <span>75%</span>
              <span>100%</span>
            </div>

            <div class="mt-3">
              <span class="badge bg-{{ hasil.css }} fs-6">{{ hasil.status }}</span>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <small class="text-muted">Gejala Terkonfirmasi</small>
              <div class="fw-bold">{{ hasil.gejala_terkonfirmasi }} dari {{ hasil.total_gejala }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted">Tingkat Keyakinan</small>
              <div class="fw-bold">{{ hasil.recommendation }}</div>
            </div>
          </div>

          {% if hasil.solusi %}
          <div class="alert alert-light border">
            <h6 class="fw-bold text-primary mb-3">
              <i class="bi bi-lightbulb me-2"></i>Rekomendasi Perbaikan:
            </h6>
            <ol class="mb-0 ps-3">
              {% for sol in hasil.solusi %}
              <li class="mb-2">{{ sol }}</li>
              {% endfor %}
            </ol>
          </div>
          {% endif %}

          <div class="d-grid gap-2 mt-4 d-print-none">
            <button onclick="window.print()" class="btn btn-outline-dark">
              <i class="bi bi-printer me-2"></i>Cetak Hasil
            </button>
            <button onclick="location.reload()" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-clockwise me-2"></i>Diagnosis Ulang
            </button>
          </div>
        </div>
      </div>
      {% endif %}

      {% if differential %}
      <div class="card mt-4 animate-up">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-compass me-2"></i>Diagnosis Alternatif
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Kemungkinan lain berdasarkan gejala yang sama:</p>
          {% for alt in differential %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong>{{ alt.nama }}</strong>
              <small class="text-muted d-block">{{ alt.kode }}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold">{{ "%.1f"|format(alt.confidence) }}%</div>
              <small class="text-muted">{{ alt.matched_symptoms }} gejala cocok</small>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}